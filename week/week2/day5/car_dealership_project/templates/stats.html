{% extends 'base.html' %}
{% block title %}Statistics & Analytics{% endblock %}

{% block content %}
  <div class="mb-6">
    <h1 class="text-2xl font-semibold">Statistics & Analytics</h1>
    <p class="text-sm text-gray-500">Live inventory insights with Chart.js</p>
  </div>

  <!-- KPI Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="bg-white border rounded-xl shadow-sm p-4">
      <div class="text-sm text-gray-500">Total Vehicles</div>
      <div class="text-3xl font-extrabold text-brand mt-1">{{ total_vehicles }}</div>
    </div>
    <div class="bg-white border rounded-xl shadow-sm p-4">
      <div class="text-sm text-gray-500">Inventory Value (DH)</div>
      <div class="text-3xl font-extrabold text-emerald-600 mt-1">
        {{ "{:,.2f}".format(inventory_value) }}
      </div>
    </div>

    <div class="bg-white border rounded-xl shadow-sm p-4">
      <div class="text-sm text-gray-500">Most Expensive</div>
      {% if most_expensive %}
        <div class="mt-1 font-semibold">
          {{ most_expensive.year }} {{ most_expensive.make }} {{ most_expensive.model }}
        </div>
        <div class="text-emerald-600 font-bold">
          {{ "{:,.2f}".format(most_expensive.price) }} DH
        </div>
        <a href="{{ url_for('vehicles.details', vehicle_id=most_expensive.id) }}"
           class="text-brand text-sm hover:underline">View</a>
      {% else %}
        <div class="mt-1 text-gray-500">—</div>
      {% endif %}
    </div>

    <div class="bg-white border rounded-xl shadow-sm p-4">
      <div class="text-sm text-gray-500">Least Expensive</div>
      {% if least_expensive %}
        <div class="mt-1 font-semibold">
          {{ least_expensive.year }} {{ least_expensive.make }} {{ least_expensive.model }}
        </div>
        <div class="text-emerald-600 font-bold">
          {{ "{:,.2f}".format(least_expensive.price) }} DH
        </div>
        <a href="{{ url_for('vehicles.details', vehicle_id=least_expensive.id) }}"
           class="text-brand text-sm hover:underline">View</a>
      {% else %}
        <div class="mt-1 text-gray-500">—</div>
      {% endif %}
    </div>
  </div>

  <!-- Charts grid -->
  <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
    <!-- Bar: Vehicles by Make -->
    <div class="bg-white border rounded-xl shadow-sm p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Vehicles by Make</h2>
      </div>
      <div class="h-72">
        <canvas id="chartByMake"></canvas>
      </div>
    </div>

    <!-- Line: Vehicles by Year -->
    <div class="bg-white border rounded-xl shadow-sm p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Vehicles by Year</h2>
      </div>
      <div class="h-72">
        <canvas id="chartByYear"></canvas>
      </div>
    </div>

    <!-- Doughnut: Price Buckets -->
    <div class="bg-white border rounded-xl shadow-sm p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Price Buckets</h2>
      </div>
      <div class="h-72">
        <canvas id="chartBuckets"></canvas>
      </div>
    </div>

    <!-- (Optional) Bar: Average Price by Make (full width under) -->
    <div class="bg-white border rounded-xl shadow-sm p-4 xl:col-span-3">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Average Price by Make</h2>
      </div>
      <div class="h-80">
        <canvas id="chartAvgPrice"></canvas>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Data from backend
    const labelsMake      = {{ labels_make|tojson }};
    const countsMake      = {{ counts_make|tojson }};
    const labelsYear      = {{ labels_year|tojson }};
    const countsYear      = {{ counts_year|tojson }};
    const bucketLabels    = {{ bucket_labels|tojson }};
    const bucketCounts    = {{ bucket_counts|tojson }};
    const labelsAvgMake   = {{ labels_avg_make|tojson }};
    const valuesAvgMake   = {{ values_avg_make|tojson }};

    // Helpers
    const fmt = n => (typeof n === 'number')
      ? n.toLocaleString('en-US')
      : n;

    const dh = n => `${fmt(n)} DH`;

    const commonOpts = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, position: 'bottom' },
        tooltip: { callbacks: { label: (ctx) => {
          const v = ctx.raw;
          // If this is the AvgPrice or a doughnut label with numbers, format as money
          if (ctx.chart.canvas.id === 'chartAvgPrice') return `${ctx.label}: ${dh(v)}`;
          if (ctx.chart.canvas.id === 'chartBuckets')  return `${ctx.label}: ${fmt(v)}`;
          return `${ctx.dataset.label || ''} ${fmt(v)}`;
        }}}
      },
      scales: {
        x: { ticks: { maxRotation: 0, autoSkip: true }},
        y: { beginAtZero: true, ticks: { callback: (val)=>fmt(val) } }
      }
    };

    // Chart 1: Vehicles by Make (bar)
    new Chart(document.getElementById('chartByMake'), {
      type: 'bar',
      data: {
        labels: labelsMake,
        datasets: [{ label: 'Count', data: countsMake }]
      },
      options: commonOpts
    });

    // Chart 2: Vehicles by Year (line)
    new Chart(document.getElementById('chartByYear'), {
      type: 'line',
      data: {
        labels: labelsYear,
        datasets: [{ label: 'Count', data: countsYear, fill: false, tension: 0.2 }]
      },
      options: commonOpts
    });

    // Chart 3: Price Buckets (doughnut)
    new Chart(document.getElementById('chartBuckets'), {
      type: 'doughnut',
      data: {
        labels: bucketLabels,
        datasets: [{ data: bucketCounts }]
      },
      options: {
        ...commonOpts,
        scales: undefined // doughnut doesn't use axes
      }
    });

    // Chart 4: Average Price by Make (bar)
    new Chart(document.getElementById('chartAvgPrice'), {
      type: 'bar',
      data: {
        labels: labelsAvgMake,
        datasets: [{ label: 'Avg Price (DH)', data: valuesAvgMake }]
      },
      options: commonOpts
    });
  </script>
{% endblock %}
